[Options]: https://pkg.go.dev/github.com/bzub/config-functions/consul?tab=doc#Options
[ConsulSnapshotSave]: https://www.consul.io/docs/commands/snapshot/save.html
[ConsulSnapshotRestore]: https://www.consul.io/docs/commands/snapshot/restore.html

# Consul Backup and Restore CronJobs

When the `backup_cron_job_enabled` [option][Options] is enabled, three CronJob
Resource configs are created.

## Backup CronJob

This CronJob periodically [saves][ConsulSnapshotSave] Secrets that Consul
depends on, as well as its state snapshot in a bundle to a backup Secret. The
name of the backup Secret is configurable with the `backup_secret_name`
[option][Options].

This backup bundle can then be downloaded via `kubectl`, or otherwise shipped
to whatever storage you like. When a restore from backups is needed, the
restore CronJobs detailed below will only need this Secret to function.

## Restore CronJobs

These CronJobs automate the task of restoring a Consul instance. Their
`spec.suspend` value is `true`, so they can only start their Job manually via
`kubectl`. The name of the Secret they look for that contains backups to
restore from is configurable with the `restore_secret_name` [option][Options].

### Restore Secrets CronJob

This CronJob restores Secrets needed by the Consul StatefulSet.

### Restore Snapshot CronJob

This CronJob runs a [snapshot restore][ConsulSnapshotRestore] against the
Consul StatefulSet.

## Disaster Recovery Example

This example picks up after the [production demo](./productionExample.md), and
refers to the same Resources/Namespace, applied to a Kubernetes cluster.

### Get A Backup Bundle Secret

First you will need a copy of a backup bundle secret generated by the [backup
CronJob](#backup-cronjob). In this case we will simply retrieve it via
`kubectl`.

```sh
# Manually trigger a backup Job in case it hasn't run yet.
kubectl -n example create job --from cronjob/my-consul-backup my-consul-backup

# Get the backup bundle secret and change the name to the restore Secret name.
kubectl -n example get secrets my-consul-example-backup -o yaml |\
  sed 's/  name: .*/  name: my-consul-example-restore/' \
  > secret_my-consul-example-restore.yaml
```

### Simulate A Disaster

We delete and recreate the Namespace Consul was deployed in, to simulate total
data loss. Then we recreate the Namespace, and apply our backup bundle Secret
to restore from.

```sh
kubectl delete ns example
kubectl create ns example
```

### Perform A Restore

There are a few high-level steps to restoring from backups in this
empty Namespace scenario.
1. Apply the backup bundle Secret, Consul ConfigMaps, and restore CronJob
   Resources.
1. Create a Secret restore Job.
1. Apply Consul server Resources, starting a new server.
1. Create a snapshot restore Job, restoring the Consul state from backups.

For this example, the following script will perform a restore:

```sh
# Apply the backup bundle Secret and Consul ConfigMaps.
kubectl apply -f secret_my-consul-example-restore.yaml
kustomize config grep "kind=ConfigMap" $DEMO |\
  kustomize config fmt |\
  kubectl apply -f -

# Apply Consul restore CronJobs.
kustomize config grep "metadata.name=my-consul-restore" $DEMO |\
  kustomize config fmt |\
  kubectl apply -f -

# Create a Secret restore Job.
kubectl -n example create job \
  --from cronjob/my-consul-restore-secrets my-consul-restore-secrets

# Apply Consul server Resources.
kustomize config grep "metadata.name=my-consul-server" demo |\
  kustomize config fmt |\
  kubectl apply -f -

# NOTE
# You may want to ensure the Consul server Pod is passing health checks before continuing.

# Create Consul snapshot restore Job.
kubectl -n example create job \
  --from cronjob/my-consul-restore-snapshot my-consul-restore-snapshot
```
